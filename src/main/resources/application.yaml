server:
  port: ${SERVER_PORT:8080}

spring:
  application:
    name: api-gateway

  data:
    redis:
      host: ${SPRING_REDIS_HOST:localhost}
      port: ${SPRING_REDIS_PORT:6379}

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${AUTH_ISSUER_URI:http://auth:8081}

  cloud:
    gateway:

      default-filters:
        - AddResponseHeader=X-Gateway,DTCC-Simulation-Gateway
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials

      routes:


        - id: simulation-service
          uri: ${SIMULATION_SERVICE_URI:http://${SIMULATION_SERVICE_HOST:pms-simulation}:${SIMULATION_SERVICE_PORT:8090}}
          predicates:
            - Path=/simulation/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 5
                redis-rate-limiter.burstCapacity: 10
                key-resolver: "#{@ipKeyResolver}"

            - name: Retry
              args:
                retries: 1
                methods: POST
                exceptions:
                  - java.net.ConnectException
                  - java.util.concurrent.TimeoutException

            - name: CircuitBreaker
              args:
                name: simulationCmd
                fallbackUri: forward:/fallback

        - id: portfolio-service
          uri: ${PORTFOLIO_SERVICE_URI:http://${PORTFOLIO_SERVICE_HOST:portfolio-id-service}:${PORTFOLIO_SERVICE_PORT:8095}}
          predicates:
            - Path=/portfolio/**

          filters:
            - name: RewritePath
              args:
                regexp: /portfolio/(?<segment>.*)
                replacement: /${segment}



        - id: analytics-service
          uri: ${ANALYTICS_SERVICE_URI:http://${ANALYTICS_SERVICE_HOST:analytics-service}:${ANALYTICS_SERVICE_PORT:8082}}
          predicates:
            - Path=/analytics/**
          filters:
            - name: RewritePath
              args:
                regexp: /analytics/(?<segment>.*)
                replacement: /api/${segment}

            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@ipKeyResolver}"

            - name: Retry
              args:
                retries: 2
                methods: GET
                exceptions:
                  - java.net.ConnectException
                  - java.util.concurrent.TimeoutException

            - name: CircuitBreaker
              args:
                name: analyticsCmd
                fallbackUri: forward:/fallback

      httpclient:
        connect-timeout: ${GATEWAY_HTTPCLIENT_CONNECT_TIMEOUT:3000}
        response-timeout: ${GATEWAY_HTTPCLIENT_RESPONSE_TIMEOUT:10s}


resilience4j:

  timelimiter:
    instances:
      simulationCmd:
        timeout-duration: 5s
      analyticsCmd:
        timeout-duration: 5s

  circuitbreaker:
    instances:
      simulationCmd:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s

      analyticsCmd:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s


logging:
  level:
    org.springframework.cloud.gateway: ${LOG_LEVEL_GATEWAY:DEBUG}
    org.springframework.security.oauth2: ${LOG_LEVEL_OAUTH2:DEBUG}
    reactor.netty.http.client: ${LOG_LEVEL_NETTY:INFO}

# App specific overrides (CORS and gateway settings)
app:
  cors:
    allowed-origins: ${CORS_ALLOWED_ORIGINS:*}
    allow-credentials: ${CORS_ALLOW_CREDENTIALS:false}
