server:
  port: 8080

gateway:
  cors:
    # Allow frontend origin (ALB DNS) - for production use exact origin
    allowed-origins: "http://k8s-pms-pmsingre-ba04040d46-2083897170.us-east-1.elb.amazonaws.com,http://localhost:4200"

spring:
  application:
    name: api-gateway

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://auth:8081

  cloud:
    gateway:
      default-filters:
        - AddResponseHeader=X-Gateway,DTCC-Simulation-Gateway
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials

      routes:
        # Auth service routes - must be FIRST
        - id: auth-service
          uri: http://auth:8081
          predicates:
            - Path=/api/auth/**

        # OAuth token endpoint (REQUIRED)
        - id: oauth-token
          uri: http://auth:8081
          predicates:
            - Path=/api/oauth2/token
            
        - id: simulation-service
          uri: http://simulation:8090
          predicates:
            - Path=/simulation/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 5
                redis-rate-limiter.burstCapacity: 10
                key-resolver: "#{@ipKeyResolver}"

            - name: Retry
              args:
                retries: 1
                methods:
                  - POST
                exceptions:
                  - java.net.ConnectException
                  - java.util.concurrent.TimeoutException

            - name: CircuitBreaker
              args:
                name: simulationCmd
                fallbackUri: forward:/fallback

        # Portfolio Service - Direct API access
        - id: api-portfolio-direct
          uri: http://portfolio:8095
          predicates:
            - Path=/api/portfolio/**

        - id: portfolio-service
          uri: http://portfolio:8095
          predicates:
            - Path=/portfolio/**
          filters:
            - name: RewritePath
              args:
                regexp: /portfolio/(?<segment>.*)
                replacement: /${segment}

        - id: analytics-actuator
          uri: http://analytics:8086
          predicates:
            - Path=/actuator/**

        - id: analytics-api-prefix
          uri: http://analytics:8086
          predicates:
            - Path=/api/analysis/**,/api/sectors/**,/api/transactions/**,/api/portfolio_value/**,/api/unrealized/**

        - id: api-leaderboard-direct
          uri: http://leaderboard:8000
          predicates:
            - Path=/api/leaderboard/**

        - id: api-rttm-direct
          uri: http://rttm:8087
          predicates:
            - Path=/api/rttm/**

        # WebSocket routes - must support WebSocket upgrade and SockJS protocol
        # RTTM WebSocket routes (SockJS endpoints at /ws/rttm/*) - MUST come before /ws/**
        - id: ws-rttm-direct
          uri: http://rttm:8087
          predicates:
            - Path=/ws/rttm/**

        # Leaderboard WebSocket (native WebSocket at /ws/updates)
        - id: ws-leaderboard
          uri: http://leaderboard:8000
          predicates:
            - Path=/ws/updates

        # Analytics WebSocket (SockJS endpoint at /ws - catches /ws, /ws/info, /ws/*, etc.)
        # This MUST come AFTER more specific /ws/* routes to avoid conflicts
        - id: ws-analytics
          uri: http://analytics:8086
          predicates:
            - Path=/ws/**

        - id: analytics-direct-analysis
          uri: http://analytics:8086
          predicates:
            - Path=/analysis/**
          filters:
            - name: RewritePath
              args:
                regexp: /analysis/(?<segment>.*)
                replacement: /api/analysis/${segment}

        - id: analytics-direct-sectors
          uri: http://analytics:8086
          predicates:
            - Path=/sectors/**
          filters:
            - name: RewritePath
              args:
                regexp: /sectors/(?<segment>.*)
                replacement: /api/sectors/${segment}

        - id: analytics-service
          uri: http://analytics:8086
          predicates:
            - Path=/analytics/**
          filters:
            - name: RewritePath
              args:
                regexp: /analytics/(?<segment>.*)
                replacement: /api/${segment}

            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@ipKeyResolver}"

            - name: Retry
              args:
                retries: 2
                methods:
                  - GET
                exceptions:
                  - java.net.ConnectException
                  - java.util.concurrent.TimeoutException

            - name: CircuitBreaker
              args:
                name: analyticsCmd
                fallbackUri: forward:/fallback

        - id: leaderboard-service
          uri: http://leaderboard:8000
          predicates:
            - Path=/leaderboard/**
          filters:
            - name: RewritePath
              args:
                regexp: /leaderboard/(?<segment>.*)
                replacement: /api/leaderboard/${segment}

            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@ipKeyResolver}"

            - name: Retry
              args:
                retries: 2
                methods:
                  - GET
                exceptions:
                  - java.net.ConnectException
                  - java.util.concurrent.TimeoutException

            - name: CircuitBreaker
              args:
                name: leaderboardCmd
                fallbackUri: forward:/fallback

        - id: rttm-service
          uri: http://rttm:8087
          predicates:
            - Path=/rttm/**
          filters:
            - name: RewritePath
              args:
                regexp: /rttm/(?<segment>.*)
                replacement: /api/rttm/${segment}

            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@ipKeyResolver}"

            - name: Retry
              args:
                retries: 2
                methods:
                  - GET
                exceptions:
                  - java.net.ConnectException
                  - java.util.concurrent.TimeoutException

            - name: CircuitBreaker
              args:
                name: rttmCmd
                fallbackUri: forward:/fallback

      httpclient:
        connect-timeout: 3000
        response-timeout: 10s

    loadbalancer:
      configurations: local

resilience4j:
  timelimiter:
    instances:
      simulationCmd:
        timeout-duration: 5s
      analyticsCmd:
        timeout-duration: 5s
      leaderboardCmd:
        timeout-duration: 5s
      rttmCmd:
        timeout-duration: 5s

  circuitbreaker:
    instances:
      simulationCmd:
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s

      analyticsCmd:
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s

      leaderboardCmd:
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s

      rttmCmd:
        sliding-window-type: COUNT_BASED
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s

logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security.oauth2: DEBUG
    reactor.netty.http.client: INFO
